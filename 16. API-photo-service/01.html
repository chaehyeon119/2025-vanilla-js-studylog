<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ì‚¬ì§„ ì¸í™” ì‹œë®¬ë ˆì´ì…˜</title>
    <style>
      img {
        max-width: 100%;
        height: auto;
      }
      #preview {
        display: none;
        width: 150px;
      }
      /* .visible {
            display: block;
          } */
      #photo-list {
        display: flex;
        flex-wrap: wrap;
      }
      .photo-item {
        width: 100px;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“¸ ì‚¬ì§„ ì¸í™” ì„œë¹„ìŠ¤</h2>
    <p>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”:</p>
    <input type="file" id="file-input" accept="image/*" />
    <br /><br />
    <img id="preview" />
    <br />
    <button id="order-btn">ğŸ“¦ ì£¼ë¬¸í•˜ê¸°</button>
    <br />
    <ul id="log"></ul>
    <section id="photo-list"></section>

    <script>
      // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
      // 2. ì•¡ì ì„ íƒ
      // 3. ë°°ì†¡ ìš”ì²­

      const BASE_URL = "https://photo-upload-test.onrender.com";

      const fileInput = document.getElementById("file-input");
      const preview = document.getElementById("preview");
      const orderBtn = document.getElementById("order-btn");
      const log = document.getElementById("log");
      const photoList = document.getElementById("photo-list");
      let selectedFile = null;

      loadPhotoList();

      // Event
      fileInput.addEventListener("change", () => {
        log.innerHTML = "";

        console.log(fileInput.files);
        const file = fileInput.files[0];

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.addEventListener("load", (e) => {
          console.log(e.target);
          preview.src = e.target.result;
          preview.style.display = "block";

          selectedFile = file;
        });
      });

      orderBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          addLog("ì¸í™”í•  ì‚¬ì§„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
          return;
        }

        addLog("ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..");

        try {
          const photoId = await uploadPhoto(selectedFile); // íŒŒì¼ ì—…ë¡œë“œ
          const orderID = await chooseFrame(photoId); // ì•¡ì ì„ íƒ
          const message = await requestDelivery(orderID); // ë°°ì†¡ ìš”ì²­
          addLog(message);
        } catch (err) {}
      });

      photoList.addEventListener("click", async (e) => {
        const filename = e.target.dataset.filename;
        if (!filename) return;

        const res = await fetch(`${BASE_URL}/api/photos/${filename}`, {
          method: "DELETE", // ì‚­ì œ
        });
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error);
        }
        // ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•œë²ˆ ë” ë¬¼ì–´ë³´ê³  ì‘ì—… ì²˜ë¦¬í•˜ê¸°
        alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadPhotoList();
      });

      // ì—…ë¡œë“œ
      async function uploadPhoto(file) {
        // íƒë°° ìƒì
        const formData = new FormData();
        // íƒë°°ìƒì(formData)ì— ì´ë¦„í‘œë¥¼ ë¶™ì´ê³  ë‚´ìš©ë¬¼ì„ ë‹´ìŒ
        formData.append("photo", file);
        // ë³´ë‚´ê¸°
        const res = await fetch(
          `${BASE_URL}/api/upload`, // ì£¼ì†Œ
          {
            method: "POST", // ì €ì¥(ì¶”ê°€
            body: formData,
          }
        );

        // ë³´ë‚´ëŠ” ì£¼ì†Œê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜, ì„œë²„ê°€ ê±°ì ˆ ë“±(ì—ëŸ¬ ë°œìƒ)
        if (!res.ok) {
          const error = await res.json();
          throw new Error("ì—…ë¡œë“œê°€ ì˜ ì•ˆëì–´ìš”!(ì—ëŸ¬ ë‚´ìš©): ", error);
        }
        // ì„±ê³µ
        const data = await res.json();
        console.log(data);
        addLog(data.message);
        // loadPhotoList()í•˜ë©´ ìƒˆë¡œê³ ì¹¨ ì•ˆ í•´ë„ ìë™ í¬í†  ì—…ë°ì´íŠ¸í•´ì¤Œ
        loadPhotoList();
        return data.photoId;
      }

      // ì•¡ìì„ íƒ
      async function chooseFrame(photoId) {
        const res = await fetch(`${BASE_URL}/api/choose-frame`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // ë³´ë‚´ëŠ” ë°ì´í„°ê°€ JSON í˜•ì‹ì„ì„ ì•Œë ¤ì¤Œ
          },
          body: JSON.stringify({ photoId }),
          // body: JSON.stringify({ photoId: photoId })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error);
        }

        // ì•¡ì ì„ íƒ ì„±ê³µ
        const data = await res.json();
        addLog(data.message);
        console.log(data);
        return data.orderId;
      }

      // ë°°ì†¡ ìš”ì²­
      async function requestDelivery(orderId) {
        const res = await fetch(`${BASE_URL}/api/delivery`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // ë³´ë‚´ëŠ” ë°ì´í„°ê°€ JSON í˜•ì‹ì„ì„ ì•Œë ¤ì¤Œ
          },
          body: JSON.stringify({ orderId }),
          // body: JSON.stringify({ photoId: photoId })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error);
        }
        const data = await res.json();
        return data.message;
      }
      // ì‚¬ì§„ ê°€ì ¸ì˜¤ê¸°
      async function loadPhotoList() {
        const res = await fetch(`${BASE_URL}/api/photos`);
        if (!res.ok) throw new Error("ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.");
        const data = await res.json();
        console.log(data);

        // photo-list DOM êµ¬ì„±
        photoList.innerHTML = "";
        data.photos.forEach((filename) => {
          const figure = document.createElement("figure");
          figure.className = "photo-item";
          figure.innerHTML = `
          <img src="${BASE_URL}/uploads/${filename}" alt="${filename}">
          <button class="delete-btn" data-filename="${filename}">ì‚­ì œ</button>
          `;
          photoList.append(figure);
        });
      }

      // ë¡œê·¸ ì¶œë ¥
      function addLog(text) {
        const li = document.createElement("li");
        li.textContent = text;
        log.append(li);
      }
    </script>
  </body>
</html>
